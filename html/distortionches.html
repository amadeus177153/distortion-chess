<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distortion Chess - Graphic Update</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --tamano-casilla: 50px;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #050505;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            overflow: hidden;
            background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); /* Fondo sutil web */
        }

        .contenedor-juego { display: flex; align-items: center; gap: 30px; }

        /* --- UI TRACKER (MONEDA) --- */
        #tracker {
            display: grid;
            grid-template-columns: 60px;
            grid-template-rows: repeat(3, 60px);
            background-color: transparent;
            gap: 5px;
        }
        .casilla-tracker {
            width: 60px; height: 60px; 
            /* Sprite del slot de moneda vacio */
            background-size: cover;
            background-position: center;
            border-radius: 50%;
            border: 2px solid #333;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.8);
        }
        .moneda {
            width: 100%; height: 100%; 
            border-radius: 50%;
            background-size: cover; 
            box-shadow: 0 0 15px #ffd700;
            animation: brilloMoneda 2s infinite alternate;
        }

        /* --- TABLERO PRINCIPAL --- */
        .layout-principal { display: none; align-items: center; gap: 30px; }
        .columna-central { display: flex; flex-direction: column; align-items: center; gap: 15px; }

        #indicador-turno {
            background-color: #333; padding: 10px 40px; border-radius: 8px; font-size: 24px;
            font-weight: bold; text-transform: uppercase; letter-spacing: 2px;
            border: 2px solid #555; min-width: 200px; text-align: center;
        }
        .turno-blancas { background: linear-gradient(90deg, #999, #fff, #999); color: #000; border: 2px solid #fff; }
        .turno-negras { background: linear-gradient(90deg, #333, #000, #333); color: #fff; border: 2px solid #444; }

        #tablero {
            display: grid; grid-template-columns: repeat(11, var(--tamano-casilla)); grid-template-rows: repeat(11, var(--tamano-casilla));
            /* Sprite del fondo general 11x11 (debajo de los huecos vac√≠os) */
            background-size: cover;
            border: 8px solid #222; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            transition: transform 1s ease;
            gap: 0; /* Quitamos gap para que los sprites encajen, usaremos bordes internos */
        }

        .rotar-tablero { transform: rotate(180deg); }

        .casilla {
            width: var(--tamano-casilla); height: var(--tamano-casilla); 
            display: flex; justify-content: center; align-items: center;
            font-size: 38px; box-sizing: border-box; cursor: pointer; user-select: none;
            position: relative;
        }

        /* CLASE PARA SPRITES DE LOS TABLEROS 3x3 */
        .sprite-tablero {
            background-repeat: no-repeat;
            /* El tama√±o debe ser 3 veces el tama√±o de la casilla (3 * 50 = 150px) */
            background-size: 150px 150px; 
        }

        .vacio-espacio {
            /* Sprite del vac√≠o */
            background-repeat: repeat;
            opacity: 0.5;
            cursor: default;
        }

        .tablero-void {
            opacity: 0.2; filter: grayscale(100%) contrast(200%); pointer-events: none;
            background-color: #000 !important;
        }

        /* --- DECK Y CARTAS --- */
        #panel-deck {
            width: 200px; background: rgba(20, 20, 40, 0.9); border: 2px solid #4444ff; border-radius: 10px;
            padding: 15px; display: flex; flex-direction: column; gap: 10px;
        }
        .titulo-deck { text-align: center; color: #fff; font-weight: bold; border-bottom: 2px solid #4444ff; }
        .contador-evento {
            background-color: #0d0d16; border: 1px solid #555; border-radius: 5px; padding: 5px;
            display: flex; justify-content: space-between; align-items: center; font-size: 14px; color: #aaa;
        }
        .contador-evento.activo { border-color: #ffd700; color: #fff; background-color: #2a2a4e; }
        .contador-evento.agotado { opacity: 0.3; text-decoration: line-through; }

        /* OVERLAYS Y UI FLOTANTE (Estilos anteriores simplificados) */
        .oculto { display: none !important; }
        #overlay-evento, #overlay-promocion, #overlay-gameover, #menu-online {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 100;
        }
        .carta-evento {
            background: #111; border: 2px solid #ffd700; padding: 20px; text-align: center; border-radius: 15px;
            width: 300px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.2); display: flex; flex-direction: column; align-items: center;
        }
        
        /* --- NUEVO: SPRITE DE LA CARTA DE EVENTO --- */
        .visual-carta {
            width: 128px; height: 128px; /* Ajustar seg√∫n tu sprite */
            background-repeat: no-repeat;
            margin: 20px auto;
            border: 2px solid #fff;
            box-shadow: 0 0 15px rgba(255,255,255,0.2);
            background-size: 400% 100%; /* 4 frames horizontales */
        }
        /* Definimos las posiciones del spritesheet */
        .sprite-slide { background-position: 0% 0%; }
        .sprite-swap { background-position: 33.33% 0%; }
        .sprite-spin { background-position: 66.66% 0%; }
        .sprite-void { background-position: 100% 0%; }

        /* Estilos Piezas (Mantener legibilidad sobre sprites) */
        .pieza-blanca { color: #fff; filter: drop-shadow(0 0 2px black); }
        .pieza-negra { color: #000; filter: drop-shadow(0 0 2px white); }
        .pieza-roca { font-size: 30px; filter: grayscale(100%); }

        /* Botones y UI Menor */
        button { cursor: pointer; padding: 10px 20px; font-weight: bold; }
        .panel-controles { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid #fff; padding: 20px; z-index: 50; text-align: center; border-radius: 10px; }
        #mensaje-sistema { position: fixed; top: 30px; left: 50%; transform: translateX(-50%); background: crimson; color: white; padding: 10px 20px; border-radius: 20px; z-index: 200; display: none; }
        
        /* Ajustes Menu */
        #menu-online .caja-menu { text-align: center; color: white; }
        input { padding: 10px; margin: 10px; }
        
        /* Promoci√≥n */
        .panel-promocion { background: #222; padding: 20px; border: 2px solid white; text-align: center; color: white; }
        .btn-promo { display: inline-block; width: 50px; height: 50px; border: 1px solid #555; font-size: 30px; margin: 5px; cursor: pointer; }

    </style>
</head>
<body>

    <div id="menu-online">
        <div class="caja-menu">
            <h1 style="color:#ffd700;">Distortion Chess</h1>
            <div id="lobby-inicio">
                <button onclick="iniciarHost()">CREAR PARTIDA</button> <br><br>
                <input type="text" id="input-id-host" placeholder="ID del Host">
                <button onclick="unirsePartida()">UNIRSE</button>
            </div>
            <div id="lobby-espera" class="oculto">
                <p>Tu ID: <input type="text" id="mi-id-display" readonly></p>
                <p>Esperando oponente...</p>
            </div>
        </div>
    </div>

    <div id="mensaje-sistema"></div>

    <div class="layout-principal" id="main-layout">
        <div id="tracker"></div> <div class="columna-central">
            <div id="indicador-turno">TURNO</div>
            <div id="tablero"></div>
        </div>

        <div id="panel-deck">
            <div class="titulo-deck">DECK</div>
            <div id="deck-slide" class="contador-evento activo"><span>SLIDE</span><span id="count-slide">3/3</span></div>
            <div id="deck-swap" class="contador-evento activo"><span>SWAP</span><span id="count-swap">3/3</span></div>
            <div id="deck-spin" class="contador-evento activo"><span>SPIN</span><span id="count-spin">3/3</span></div>
            <div id="deck-void" class="contador-evento activo" style="color:#f88"><span>VOID</span><span id="count-void">1/1</span></div>
        </div>
    </div>

    <div id="overlay-evento" class="oculto">
        <div class="carta-evento">
            <h2 id="titulo-evento">EVENTO</h2>
            <div id="visual-carta" class="visual-carta"></div>
            <p id="descripcion-evento"></p>
            <button id="btn-usar-carta" onclick="cerrarEventoYActivarModo()">USAR</button>
        </div>
    </div>

    <div id="overlay-promocion" class="oculto">
        <div class="panel-promocion">
            <h3>PROMOCI√ìN</h3>
            <div id="opciones-promo-container"></div>
        </div>
    </div>

    <div id="overlay-gameover" class="oculto">
        <div class="panel-promocion">
            <h1 id="texto-victoria">FIN</h1>
            <p id="subtitulo-victoria"></p>
            <button onclick="location.reload()">REINICIAR</button>
        </div>
    </div>

    <div id="controles-slide" class="panel-controles oculto">
        <h3>SLIDE</h3>
        <button onclick="ejecutarSlide('ARRIBA')">‚¨Ü</button><button onclick="ejecutarSlide('ABAJO')">‚¨á</button>
        <button onclick="ejecutarSlide('IZQUIERDA')">‚¨Ö</button><button onclick="ejecutarSlide('DERECHA')">‚û°</button>
        <br><button onclick="reiniciarSeleccion()" style="margin-top:10px; font-size:12px">Cancelar</button>
    </div>
    <div id="controles-spin" class="panel-controles oculto">
        <h3>SPIN</h3>
        <button onclick="ejecutarSpin('ANTIHORARIO')">‚Ü∫ -90¬∞</button><button onclick="ejecutarSpin('HORARIO')">‚Üª +90¬∞</button>
        <br><button onclick="reiniciarSeleccion()" style="margin-top:10px; font-size:12px">Cancelar</button>
    </div>
    <div id="controles-swap" class="panel-controles oculto">
        <h3>SWAP</h3><p>Elige el segundo tablero</p>
        <button onclick="reiniciarSeleccion()">Cancelar</button>
    </div>
    <div id="controles-void" class="panel-controles oculto">
        <h3>VOID</h3><p>Elige tablero a anular</p>
        <button onclick="reiniciarSeleccion()">Cancelar</button>
    </div>

    <script>
    // ==========================================
    // 1. CONFIGURACI√ìN DE ASSETS (URLS)
    // ==========================================
    // REEMPLAZA ESTAS URLS CON LAS TUYAS (Imgur, GitHub Pages, etc.)
    const ASSETS = {
        // Sprite para el vac√≠o del espacio (entre tableros)
        vacio: "https://www.transparenttextures.com/patterns/stardust.png", 
        
        // Sprite del Tablero Global 11x11 (Fondo general detr√°s de todo)
        tableroGlobal: "https://www.transparenttextures.com/patterns/dark-matter.png",

        // Sprites para los tableros 3x3 (Deben ser texturas cuadradas seamless)
        // Tipo 0, 1, 2 son los colores/estilos de tablero que definiste
        tableros: {
            0: "https://www.transparenttextures.com/patterns/wood-pattern.png", // Ejemplo madera
            1: "https://www.transparenttextures.com/patterns/black-scales.png", // Ejemplo escamas
            2: "https://www.transparenttextures.com/patterns/blue-squares.png"  // Ejemplo futurista
        },

        // Sprite Sheet de Eventos (Debe tener 4 iconos en horizontal: SLIDE | SWAP | SPIN | VOID)
        sheetEventos: "https://i.imgur.com/example-sheet.png", // Placeholder, necesitar√°s crear esta imagen

        // Tracker de moneda
        slotMoneda: "https://www.transparenttextures.com/patterns/diagmonds-light.png",
        moneda: "https://www.transparenttextures.com/patterns/gold-scale.png" // Textura dorada
    };

    // Aplicar fondos globales al inicio
    document.getElementById('tablero').style.backgroundImage = `url('${ASSETS.tableroGlobal}')`;


    // --- VARIABLES DE RED Y JUEGO ---
    let peer = null, conn = null, miColor = null;
    const tableroHTML = document.getElementById('tablero');
    const tracker = document.getElementById('tracker');
    
    // Elementos UI
    const overlayEvento = document.getElementById('overlay-evento');
    const visualCarta = document.getElementById('visual-carta'); // DIV del Sprite
    const tituloEvento = document.getElementById('titulo-evento');
    const descEvento = document.getElementById('descripcion-evento');
    const btnUsarCarta = document.getElementById('btn-usar-carta');

    // Paneles Controles
    const controlesSlide = document.getElementById('controles-slide');
    const controlesSpin = document.getElementById('controles-spin');
    const controlesSwap = document.getElementById('controles-swap');
    const controlesVoid = document.getElementById('controles-void');
    const mensajeSistema = document.getElementById('mensaje-sistema');
    
    // Estado
    const TAMANO_TABLERO = 11; 
    let turnoActual = 'BLANCAS';
    let seleccion = null, enJaque = false, posicionMoneda = 2, modoJuego = 'NORMAL', juegoTerminado = false;
    let jugadorEvento = null, eventoPendiente = null, promocionPendiente = null, colaPromociones = [];
    let promocionDesdeEvento = false, tableroVoidID = null, enPassantTarget = null;
    let seleccionSlide = null, seleccionSpin = null, seleccionSwap1 = null;

    let deckState = { SLIDE: 3, SWAP: 3, SPIN: 3, VOID: 1 };
    
    const P = {
        BLANCAS: { T: '‚ôñ', C: '‚ôò', A: '‚ôó', R: '‚ôî', D: '‚ôï', P: '‚ôô' },
        NEGRAS:  { T: '‚ôú', C: '‚ôû', A: '‚ôù', R: '‚ôö', D: '‚ôõ', P: '‚ôü' },
        ROCA: 'ü™®', VACIO: ''
    };

    // --- GENERACI√ìN DE DATOS (Igual que antes) ---
    function crearHistorialVacio() { return [[false,false,false],[false,false,false],[false,false,false]]; }
    function generarTablerosIniciales() {
        return [
            { id: 0, piezas: [[P.ROCA, P.NEGRAS.T, P.NEGRAS.C], [P.VACIO, P.NEGRAS.P, P.NEGRAS.P], [P.VACIO, P.VACIO, P.VACIO]], matriz: [[1,0,1], [0,1,0], [1,0,1]], historial: crearHistorialVacio(), tipoSprite: 0 },
            { id: 1, piezas: [[P.NEGRAS.A, P.NEGRAS.D, P.NEGRAS.R], [P.NEGRAS.P, P.NEGRAS.P, P.NEGRAS.P], [P.VACIO, P.VACIO, P.VACIO]], matriz: [[0,1,0], [1,0,1], [0,1,0]], historial: crearHistorialVacio(), tipoSprite: 1 },
            { id: 2, piezas: [[P.NEGRAS.A, P.NEGRAS.C, P.NEGRAS.T], [P.NEGRAS.P, P.NEGRAS.P, P.NEGRAS.P], [P.VACIO, P.VACIO, P.VACIO]], matriz: [[1,0,1], [0,1,0], [1,0,1]], historial: crearHistorialVacio(), tipoSprite: 0 },
            { id: 3, piezas: [[P.VACIO, P.VACIO, P.VACIO], [P.ROCA, P.VACIO, P.VACIO], [P.VACIO, P.VACIO, P.VACIO]], matriz: [[0,1,0], [1,0,1], [0,1,0]], historial: crearHistorialVacio(), tipoSprite: 1 },
            { id: 4, piezas: [[P.VACIO, P.ROCA,  P.VACIO], [P.VACIO,  P.VACIO, P.VACIO], [P.VACIO, P.ROCA,  P.VACIO]], matriz: [[1,0,1], [0,1,0], [1,0,1]], historial: crearHistorialVacio(), tipoSprite: 2 }, // Centro diferente
            { id: 5, piezas: [[P.VACIO, P.VACIO, P.VACIO], [P.VACIO, P.VACIO, P.ROCA], [P.VACIO, P.VACIO, P.VACIO]], matriz: [[0,1,0], [1,0,1], [0,1,0]], historial: crearHistorialVacio(), tipoSprite: 1 },
            { id: 6, piezas: [[P.VACIO, P.VACIO, P.VACIO], [P.BLANCAS.P, P.BLANCAS.P, P.BLANCAS.P], [P.BLANCAS.T, P.BLANCAS.C, P.BLANCAS.A]], matriz: [[1,0,1], [0,1,0], [1,0,1]], historial: crearHistorialVacio(), tipoSprite: 0 },
            { id: 7, piezas: [[P.VACIO, P.VACIO, P.VACIO], [P.BLANCAS.P, P.BLANCAS.P, P.BLANCAS.P], [P.BLANCAS.D, P.BLANCAS.R, P.BLANCAS.A]], matriz: [[0,1,0], [1,0,1], [0,1,0]], historial: crearHistorialVacio(), tipoSprite: 1 },
            { id: 8, piezas: [[P.VACIO, P.VACIO, P.VACIO], [P.BLANCAS.P, P.BLANCAS.P, P.VACIO], [P.BLANCAS.C, P.BLANCAS.T, P.ROCA]], matriz: [[1,0,1], [0,1,0], [1,0,1]], historial: crearHistorialVacio(), tipoSprite: 0 },
        ];
    }
    // Nota: A√±ad√≠ 'tipoSprite' a la data para saber qu√© textura usar en cada tablero.
    
    function generarPosicionesIniciales() {
        return [
            { id: 0, r: 1, c: 1 }, { id: 1, r: 1, c: 4 }, { id: 2, r: 1, c: 7 },
            { id: 3, r: 4, c: 1 }, { id: 4, r: 4, c: 4 }, { id: 5, r: 4, c: 7 },
            { id: 6, r: 7, c: 1 }, { id: 7, r: 7, c: 4 }, { id: 8, r: 7, c: 7 }
        ];
    }

    let CONFIGURACION_TABLEROS = generarTablerosIniciales();
    let estadoTableros = generarPosicionesIniciales();
    let tablerosConRey = Array(9).fill(null).map(()=>[]);
    let vecinosTableros = [];

    // ==========================================
    // L√ìGICA DE RED (Simplificada para el ejemplo)
    // ==========================================
    function iniciarHost() {
        document.getElementById('lobby-inicio').classList.add('oculto');
        document.getElementById('lobby-espera').classList.remove('oculto');
        miColor = 'BLANCAS';
        peer = new Peer();
        peer.on('open', id => document.getElementById('mi-id-display').value = id);
        peer.on('connection', c => { conn = c; configurarConexion(); comenzarJuegoUI(); });
    }
    function unirsePartida() {
        const id = document.getElementById('input-id-host').value;
        if(!id) return;
        miColor = 'NEGRAS';
        peer = new Peer();
        peer.on('open', () => { conn = peer.connect(id); configurarConexion(); comenzarJuegoUI(); });
    }
    function configurarConexion() {
        conn.on('data', data => procesarDatosRemotos(data));
        conn.on('open', () => console.log("Conectado"));
    }
    function enviarDatos(tipo, payload) { if(conn && conn.open) conn.send({type: tipo, payload: payload}); }
    
    function comenzarJuegoUI() {
        document.getElementById('menu-online').classList.add('oculto');
        document.getElementById('main-layout').style.display = 'flex';
        if(miColor === 'NEGRAS') tableroHTML.classList.add('rotar-tablero');
        resetearJuego();
    }

    // ==========================================
    // PROCESAMIENTO DE DATOS
    // ==========================================
    function procesarDatosRemotos(data) {
        if(data.type !== 'CARD_EVENT') overlayEvento.classList.add('oculto');
        switch(data.type) {
            case 'MOVE': ejecutarMovimientoFisico(data.payload.fOri, data.payload.cOri, data.payload.fDest, data.payload.cDest, data.payload.pieza); continuarFinTurno(true); break;
            case 'PROMOTE': promocionPendiente = data.payload; if(colaPromociones.length>0) colaPromociones.shift(); realizarPromocion(data.payload.pieza, true); break;
            case 'CARD_EVENT': deckState[data.payload.evento]--; tableroVoidID = null; actualizarUIDeck(); mostrarCartaForzada(data.payload.jugador, data.payload.evento); break;
            case 'SLIDE': seleccionSlide = data.payload.id; ejecutarSlide(data.payload.dir, true); break;
            case 'SPIN': seleccionSpin = data.payload.id; ejecutarSpin(data.payload.sentido, true); break;
            case 'SWAP': ejecutarSwap(data.payload.id1, data.payload.id2, true); break;
            case 'VOID': manejarClicVoid(data.payload.id, true); break;
        }
        crearTablero();
    }

    // ==========================================
    // RENDERIZADO VISUAL (LO IMPORTANTE)
    // ==========================================
    
    function dibujarTracker() {
        tracker.innerHTML = '';
        for (let i = 0; i < 3; i++) {
            const casilla = document.createElement('div');
            casilla.className = 'casilla-tracker';
            // Sprite del slot vacio
            casilla.style.backgroundImage = `url('${ASSETS.slotMoneda}')`; 

            if (i === posicionMoneda) {
                const moneda = document.createElement('div');
                moneda.className = 'moneda';
                // Sprite de la moneda
                moneda.style.backgroundImage = `url('${ASSETS.moneda}')`;
                casilla.appendChild(moneda);
            }
            tracker.appendChild(casilla);
        }
    }

    function crearTablero() {
        tableroHTML.innerHTML = ''; 
        const posReyActual = encontrarRey(turnoActual);
        const bandoEnemigo = turnoActual === 'BLANCAS' ? 'NEGRAS' : 'BLANCAS';
        let jaqueVisual = posReyActual ? esCasillaAtacada(posReyActual.f, posReyActual.c, bandoEnemigo) : false;

        for (let fila = 0; fila < TAMANO_TABLERO; fila++) {
            for (let col = 0; col < TAMANO_TABLERO; col++) {
                const casilla = document.createElement('div');
                casilla.classList.add('casilla');
                
                const datos = accederDatosTablero(fila, col);
                
                if (datos) {
                    // --- AQUI ESTA LA MAGIA DE LOS SPRITES ---
                    if (datos.isVoid) {
                        casilla.classList.add('tablero-void');
                    } else {
                        // 1. Asignar imagen base seg√∫n el tipo de tablero (0, 1 o 2)
                        const tipo = datos.config.tipoSprite !== undefined ? datos.config.tipoSprite : 0;
                        casilla.classList.add('sprite-tablero');
                        casilla.style.backgroundImage = `url('${ASSETS.tableros[tipo]}')`;
                        
                        // 2. CALCULAR OFFSET (Para que parezca una sola imagen grande de 3x3)
                        // Si la casilla es la fila local 0 y col local 0, el background-position es 0 0.
                        // Si es fila 1, desplazamos el background hacia arriba (-50px), etc.
                        const tamanoC = 50; // px
                        const posX = -(datos.c * tamanoC);
                        const posY = -(datos.f * tamanoC);
                        casilla.style.backgroundPosition = `${posX}px ${posY}px`;

                        // 3. Renderizar Pieza
                        const pieza = datos.config.piezas[datos.f][datos.c];
                        const divPieza = document.createElement('div');
                        divPieza.style.width = '100%'; divPieza.style.height = '100%';
                        divPieza.style.display = 'flex'; divPieza.style.justifyContent = 'center'; divPieza.style.alignItems = 'center';
                        if(miColor === 'NEGRAS') divPieza.style.transform = 'rotate(180deg)';
                        
                        if (pieza !== '') {
                            divPieza.innerText = pieza;
                            if (pieza === P.ROCA) casilla.classList.add('pieza-roca');
                            else if ('‚ôñ‚ôò‚ôó‚ôî‚ôï‚ôô'.includes(pieza)) casilla.classList.add('pieza-blanca');
                            else casilla.classList.add('pieza-negra');
                        }
                        casilla.appendChild(divPieza);

                        // Bordes internos 3x3
                        const borderStyle = '1px solid rgba(255,255,255,0.3)';
                        // Podemos simplificar bordes o dejarlos
                        if(datos.f===0) casilla.style.borderTop = "3px solid #555";
                        if(datos.f===2) casilla.style.borderBottom = "3px solid #555";
                        if(datos.c===0) casilla.style.borderLeft = "3px solid #555";
                        if(datos.c===2) casilla.style.borderRight = "3px solid #555";
                    }

                    // Efectos de selecci√≥n (Bordes brillantes en lugar de fondos planos)
                    if (modoJuego === 'EVENTO_SWAP_2' && datos.idTablero === seleccionSwap1) casilla.style.boxShadow = 'inset 0 0 15px blue';
                    if (modoJuego === 'EVENTO_SPIN' && datos.idTablero === seleccionSpin) casilla.style.boxShadow = 'inset 0 0 15px yellow';
                    if (modoJuego === 'EVENTO_SLIDE' && datos.idTablero === seleccionSlide) casilla.style.boxShadow = 'inset 0 0 15px orange';

                } else { 
                    // ESPACIO VAC√çO
                    casilla.classList.add('vacio-espacio'); 
                    casilla.style.backgroundImage = `url('${ASSETS.vacio}')`;
                }
                
                const logF = fila, logC = col;
                casilla.onclick = () => manejarClic(logF, logC);
                
                // Selecci√≥n de movimiento
                if (seleccion && seleccion.fila === logF && seleccion.col === logC) casilla.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
                if (seleccion) {
                    const move = seleccion.movimientos.find(m => m.f === logF && m.c === logC);
                    if (move) { 
                        // Indicador de movimiento posible (Punto o brillo)
                        casilla.style.boxShadow = 'inset 0 0 10px #0f0'; 
                        casilla.style.cursor = 'pointer'; 
                    }
                }
                if (jaqueVisual && posReyActual && posReyActual.f === logF && posReyActual.c === logC) {
                    casilla.style.backgroundColor = 'rgba(255, 0, 0, 0.5)'; casilla.style.boxShadow = '0 0 20px red';
                }
                tableroHTML.appendChild(casilla);
            }
        }
        dibujarTracker();
    }

    // ==========================================
    // LOGICA VISUAL CARTAS (SPRITESHEET)
    // ==========================================

    function mostrarCartaForzada(jugador, evento) {
        eventoPendiente = evento;
        jugadorEvento = jugador;
        
        // Configurar Textos
        if (evento === 'SLIDE') { 
            tituloEvento.innerText = "SLIDE"; 
            descEvento.innerText = `¬°${jugador} mueve filas!`; 
        } 
        else if (evento === 'SWAP') { 
            tituloEvento.innerText = "SWAP"; 
            descEvento.innerText = `¬°${jugador} intercambia tableros!`; 
        } 
        else if (evento === 'SPIN') { 
            tituloEvento.innerText = "SPIN"; 
            descEvento.innerText = `¬°${jugador} rota la realidad!`; 
        }
        else if (evento === 'VOID') { 
            tituloEvento.innerText = "VOID"; 
            descEvento.innerText = `¬°${jugador} invoca el vac√≠o!`; 
        }
        
        // CONFIGURAR SPRITE
        // Primero, aseguramos que la imagen base sea el sheet
        visualCarta.style.backgroundImage = `url('${ASSETS.sheetEventos}')`; // (Si no lo definiste en CSS)
        
        // Limpiamos clases previas
        visualCarta.className = 'visual-carta'; 
        // A√±adimos la clase especifica para mover el background-position
        visualCarta.classList.add(`sprite-${evento.toLowerCase()}`);

        overlayEvento.classList.remove('oculto');
        
        if (jugador === miColor) {
            btnUsarCarta.disabled = false; btnUsarCarta.innerText = "ACTIVAR"; btnUsarCarta.style.opacity = "1";
        } else {
            btnUsarCarta.disabled = true; btnUsarCarta.innerText = "ESPERANDO..."; btnUsarCarta.style.opacity = "0.5";
        }
    }

    // ==========================================
    // RESTO DE LA L√ìGICA DEL JUEGO (MANTENIDA)
    // ==========================================
    // Copia aqu√≠ las funciones l√≥gicas que no son de UI (movimientos, reglas, etc.)
    // Para simplificar, he mantenido la estructura base pero asegurate de que funciones como:
    // resetearJuego, accederDatosTablero, obtenerMovimientosBase, etc.
    // est√©n presentes tal cual estaban en tu c√≥digo original.
    
    // --- [INSERTA AQU√ç LAS FUNCIONES L√ìGICAS FALTANTES DEL C√ìDIGO ANTERIOR] ---
    // (resetearJuego, actualizarUIDeck, verificarFinDeJuego, etc...)
    // Por brevedad, he puesto solo las que cambian visualmente.
    
    // IMPORTANTE: Asegurate de definir resetearJuego() completa, incluyendo
    // CONFIGURACION_TABLEROS = generarTablerosIniciales();
    // estadoTableros = generarPosicionesIniciales();
    // crearTablero(); dibujarTracker();
    
    function resetearJuego() {
        turnoActual = 'BLANCAS'; seleccion = null; enJaque = false; posicionMoneda = 2; modoJuego = 'NORMAL';
        juegoTerminado = false; tableroVoidID = null; enPassantTarget = null; colaPromociones = []; promocionDesdeEvento = false;
        deckState = { SLIDE: 3, SWAP: 3, SPIN: 3, VOID: 1 };
        
        CONFIGURACION_TABLEROS = generarTablerosIniciales();
        estadoTableros = generarPosicionesIniciales();
        
        // Reiniciar Historial
        CONFIGURACION_TABLEROS.forEach(t => t.historial = crearHistorialVacio());

        document.getElementById('overlay-gameover').classList.add('oculto');
        actualizarUIDeck();
        actualizarTurnoUI();
        actualizarUbicacionReyes();
        calcularVecinos();
        crearTablero();
        dibujarTracker();
    }

    // Funciones auxiliares m√≠nimas para que corra el demo visual
    function actualizarUIDeck() {
        ['slide','swap','spin','void'].forEach(e => {
            const el = document.getElementById(`deck-${e}`);
            const count = document.getElementById(`count-${e}`);
            const val = deckState[e.toUpperCase()];
            count.innerText = `${val}/${e==='void'?1:3}`;
            if(val===0) { el.classList.remove('activo'); el.classList.add('agotado'); }
            else { el.classList.add('activo'); el.classList.remove('agotado'); }
        });
    }
    function actualizarTurnoUI() {
        const ind = document.getElementById('indicador-turno');
        ind.innerText = `TURNO: ${turnoActual}`;
        ind.className = turnoActual === 'BLANCAS' ? 'turno-blancas' : 'turno-negras';
    }
    function cerrarEventoYActivarModo() {
        overlayEvento.classList.add('oculto');
        if (jugadorEvento === miColor) reiniciarSeleccion();
    }
    function reiniciarSeleccion() {
        seleccionSlide=null; seleccionSpin=null; seleccionSwap1=null;
        ['slide','spin','swap','void'].forEach(id => document.getElementById(`controles-${id}`).classList.add('oculto'));
        
        if (eventoPendiente === 'SLIDE') { modoJuego='EVENTO_SLIDE'; mostrarMensaje("Selecciona tablero para deslizar"); }
        else if (eventoPendiente === 'SWAP') { modoJuego='EVENTO_SWAP_1'; mostrarMensaje("Selecciona primer tablero"); }
        else if (eventoPendiente === 'SPIN') { modoJuego='EVENTO_SPIN'; mostrarMensaje("Selecciona tablero para rotar"); }
        else if (eventoPendiente === 'VOID') { modoJuego='EVENTO_VOID'; mostrarMensaje("Selecciona tablero para anular"); }
        crearTablero();
    }
    function mostrarMensaje(txt) { mensajeSistema.innerText=txt; mensajeSistema.style.display='block'; setTimeout(()=>mensajeSistema.style.display='none', 3000); }
    
    // --- [RESTO DE LOGICA QUE YA TIENES: accederDatosTablero, movimientos, etc.] ---
    // Necesitas pegar aqu√≠ el resto de funciones l√≥gicas de tu archivo original:
    // accederDatosTablero, obtenerPiezaEn, esPiezaDelTurno, obtenerMovimientosBase, 
    // esCasillaAtacada, encontrarRey, obtenerMovimientosLegales, avanzarMoneda,
    // ejecutarMovimientoFisico, verificarPromocion, realizarPromocion, finalizarEvento,
    // manejarClic, manejarClicSwap, manejarClicVoid, prepararSpin, ejecutarSpin, etc.
    
    // (Para que funcione al copiar y pegar, aseg√∫rate de traer esas funciones del archivo anterior)
    
    // ==========================================
    // FUNCIONES CLAVE FALTANTES (Placeholders para que no rompa el ejemplo visual)
    // ==========================================
    function accederDatosTablero(fila, col) {
        if (fila < 0 || fila > 10 || col < 0 || col > 10) return null;
        for (let t of estadoTableros) {
            if (fila >= t.r && fila < t.r + 3 && col >= t.c && col < t.c + 3) {
                return { config: CONFIGURACION_TABLEROS[t.id], f: fila - t.r, c: col - t.c, idTablero: t.id, isVoid: t.id === tableroVoidID };
            }
        }
        return null; 
    }
    function encontrarRey(bando) { return null; } // Placeholder
    function esCasillaAtacada() { return false; } // Placeholder
    function actualizarUbicacionReyes() {} // Placeholder
    function calcularVecinos() {} // Placeholder
    function manejarClic(f, c) { console.log("Clic en", f, c); } // Placeholder interacci√≥n
    
    </script>
</body>
</html>
